#ifndef CONTROL_H
#define CONTROL_H

#include <Arduino.h>

// ============================================================
// üéÆ –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏–µ–º —Å Watchdog —Ç–∞–π–º–∞—É—Ç–æ–º
// ============================================================
//
// –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ "–∂–∏–≤–æ–µ" —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–≤–µ—Ä–æ–º.
// –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ CONTROL_TIMEOUT_MS,
// –º–æ—Ç–æ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è (watchdog).
//
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
//   - –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∂–æ–π—Å—Ç–∏–∫–æ–≤ (—Å—Ç–∏–∫–æ–≤)
//   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
//   - –õ—é–±–æ–≥–æ real-time —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
//
// –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
//   - –û—Ç–ª–∞–¥–æ—á–Ω—ã—Ö increment/decrement –∫–æ–º–∞–Ω–¥ (/api/drive)
//   - –î–µ–º–æ-—Ä–µ–∂–∏–º–∞
//
// ============================================================

// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Watchdog ---
// –í—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ—Ç–æ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è
// –µ—Å–ª–∏ –Ω–µ –ø–æ—Å—Ç—É–ø–∏–ª–∞ –Ω–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
#define CONTROL_TIMEOUT_MS 3000

// --- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è ---
// –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —É–ø—Ä–æ—â—ë–Ω–Ω–æ–≥–æ API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
enum ControlDirection : uint8_t {
    CTRL_STOP = 0,       // –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    CTRL_FORWARD,        // –í–ø–µ—Ä—ë–¥ (–æ–±–∞ –ø–µ—Ä–µ–¥–Ω–∏—Ö)
    CTRL_BACKWARD,       // –ù–∞–∑–∞–¥ (–æ–±–∞ –∑–∞–¥–Ω–∏—Ö)
    CTRL_LEFT,           // –ü–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ
    CTRL_RIGHT,          // –ü–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ
    CTRL_ROTATE_LEFT,    // –†–∞–∑–≤–æ—Ä–æ—Ç –Ω–∞ –º–µ—Å—Ç–µ –≤–ª–µ–≤–æ
    CTRL_ROTATE_RIGHT    // –†–∞–∑–≤–æ—Ä–æ—Ç –Ω–∞ –º–µ—Å—Ç–µ –≤–ø—Ä–∞–≤–æ
};

// --- –°–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
struct ControlState {
    ControlDirection direction;  // –¢–µ–∫—É—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    uint8_t speed;               // –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (0-255)
    unsigned long lastCommandMs; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã (millis)
    bool active;                 // –ê–∫—Ç–∏–≤–Ω–æ –ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
};

// ============================================================
// API —Ñ—É–Ω–∫—Ü–∏–∏
// ============================================================

/**
 * @brief –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
 * –í—ã–∑—ã–≤–∞—Ç—å –≤ setup() –ø–æ—Å–ª–µ driveInit()
 */
void controlInit();

/**
 * @brief –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ watchdog —Ç–∞–π–º–µ—Ä–∞
 * –í—ã–∑—ã–≤–∞—Ç—å –≤ loop() ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∞–π–º–∞—É—Ç –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ—Ç–æ—Ä—ã
 */
void controlUpdate();

/**
 * @brief –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç watchdog —Ç–∞–π–º–µ—Ä
 * 
 * @param direction –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ enum ControlDirection
 * @param speed –°–∫–æ—Ä–æ—Å—Ç—å 0-255
 */
void controlSetMovement(ControlDirection direction, uint8_t speed);

/**
 * @brief –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –æ—Å—è–º X/Y (–¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞)
 * X: -255..+255 (–ª–µ–≤–æ..–ø—Ä–∞–≤–æ)
 * Y: -255..+255 (–Ω–∞–∑–∞–¥..–≤–ø–µ—Ä—ë–¥)
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç watchdog —Ç–∞–π–º–µ—Ä
 * 
 * @param x –û—Å—å X (-255 –ª–µ–≤–æ, +255 –ø—Ä–∞–≤–æ)
 * @param y –û—Å—å Y (-255 –Ω–∞–∑–∞–¥, +255 –≤–ø–µ—Ä—ë–¥)
 */
void controlSetXY(int16_t x, int16_t y);

/**
 * @brief –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
 * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ—Ç–æ—Ä—ã –∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
 */
void controlStop();

/**
 * @brief –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
 * @return –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É ControlState
 */
const ControlState& controlGetState();

/**
 * @brief –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ watchdog (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
 * @return true –µ—Å–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
 */
bool controlIsActive();

#endif // CONTROL_H
