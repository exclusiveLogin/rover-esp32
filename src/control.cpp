/**
 * ============================================================
 * üéÆ control.cpp ‚Äî –ú–æ–¥—É–ª—å –∂–∏–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å Watchdog
 * ============================================================
 *
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ "–∂–∏–≤–æ–µ" (real-time) —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–≤–µ—Ä–æ–º –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–æ–≤.
 *
 * –ö–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî Watchdog:
 *   –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ CONTROL_TIMEOUT_MS (2 —Å–µ–∫),
 *   –º–æ—Ç–æ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç
 *   –Ω–µ—É–ø—Ä–∞–≤–ª—è–µ–º–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏.
 *
 * –†–µ–∂–∏–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
 *   1. –ü–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é (controlSetMovement) ‚Äî forward, backward, left, right
 *   2. –ü–æ –æ—Å—è–º X/Y (controlSetXY) ‚Äî –æ—Ç –¥–∂–æ–π—Å—Ç–∏–∫–∞, —Å skid-steer –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
 *
 * Skid-steer –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–∞–Ω–∫–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ):
 *   leftSpeed  = Y + X    (Y = –≥–∞–∑, X = –ø–æ–≤–æ—Ä–æ—Ç)
 *   rightSpeed = Y - X
 *   –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 255 ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π.
 *
 * –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
 *   - drive.h  ‚Äî driveSetSpeed(), driveStop() –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ—Ç–æ—Ä–∞–º–∏
 *   - config.h ‚Äî CONTROL_TIMEOUT_MS, CONTROL_DEADZONE
 *
 * ============================================================
 */

#include "control.h"
#include "drive.h"
#include "config.h"

// --- –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
static ControlState state = {
    .direction = CTRL_STOP,
    .speed = 0,
    .lastCommandMs = 0,
    .active = false
};

// ============================================================
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
// ============================================================

/**
 * @brief –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤—ã–≤–æ–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é watchdog –≤ Serial.
 * –í—ã–∑—ã–≤–∞—Ç—å –≤ setup() –ø–æ—Å–ª–µ driveInit().
 */
void controlInit() {
    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    state.direction = CTRL_STOP;
    state.speed = 0;
    state.lastCommandMs = 0;
    state.active = false;
    
    Serial.println("‚úÖ Control –º–æ–¥—É–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    Serial.printf("   ‚è±Ô∏è Watchdog —Ç–∞–π–º–∞—É—Ç: %d –º—Å\n", CONTROL_TIMEOUT_MS);
}

// ============================================================
// Watchdog Update ‚Äî –≤—ã–∑—ã–≤–∞—Ç—å –≤ loop()
// ============================================================

/**
 * @brief –ü—Ä–æ–≤–µ—Ä–∫–∞ watchdog-—Ç–∞–π–º–∞—É—Ç–∞
 *
 * –ï—Å–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ –∏ –ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ CONTROL_TIMEOUT_MS –º—Å
 * —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—Ç–æ—Ä–æ–≤.
 * –í—ã–∑—ã–≤–∞—Ç—å –≤ loop() –∫–∞–∂–¥—ã–π —Ü–∏–∫–ª.
 */
void controlUpdate() {
    // –ï—Å–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (!state.active) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–π–º–∞—É—Ç
    unsigned long now = millis();
    unsigned long elapsed = now - state.lastCommandMs;
    
    if (elapsed >= CONTROL_TIMEOUT_MS) {
        // –¢–∞–π–º–∞—É—Ç! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ—Ç–æ—Ä—ã
        Serial.printf("‚è±Ô∏è Watchdog: —Ç–∞–π–º–∞—É—Ç %lu –º—Å, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ—Ç–æ—Ä–æ–≤\n", elapsed);
        controlStop();
    }
}

// ============================================================
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
// ============================================================

/**
 * @brief –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç watchdog-—Ç–∞–π–º–µ—Ä. –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤ drive-–º–æ–¥—É–ª—å.
 * @param direction –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ enum ControlDirection
 * @param speed     –°–∫–æ—Ä–æ—Å—Ç—å 0-255
 */
void controlSetMovement(ControlDirection direction, uint8_t speed) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    state.direction = direction;
    state.speed = speed;
    state.lastCommandMs = millis();  // –°–±—Ä–æ—Å watchdog
    state.active = (direction != CTRL_STOP);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –º–æ—Ç–æ—Ä–∞–º —á–µ—Ä–µ–∑ drive –º–æ–¥—É–ª—å
    switch (direction) {
        case CTRL_STOP:
            driveStop();
            break;
            
        case CTRL_FORWARD:
            // –í–ø–µ—Ä—ë–¥: FL + FR –∞–∫—Ç–∏–≤–Ω—ã
            driveForward(speed);
            break;
            
        case CTRL_BACKWARD:
            // –ù–∞–∑–∞–¥: RL + RR –∞–∫—Ç–∏–≤–Ω—ã
            driveBackward(speed);
            break;
            
        case CTRL_LEFT:
            // –ü–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ: —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
            driveTurnLeft(speed);
            break;
            
        case CTRL_RIGHT:
            // –ü–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ: —Ç–æ–ª—å–∫–æ –ª–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
            driveTurnRight(speed);
            break;
            
        case CTRL_ROTATE_LEFT:
            // –†–∞–∑–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ: –ø—Ä–∞–≤–∞—è –≤–ø–µ—Ä—ë–¥, –ª–µ–≤–∞—è –Ω–∞–∑–∞–¥
            driveRotateLeft(speed);
            break;
            
        case CTRL_ROTATE_RIGHT:
            // –†–∞–∑–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ: –ª–µ–≤–∞—è –≤–ø–µ—Ä—ë–¥, –ø—Ä–∞–≤–∞—è –Ω–∞–∑–∞–¥
            driveRotateRight(speed);
            break;
    }
}

// ============================================================
// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –æ—Å—è–º X/Y (–¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞)
// ============================================================
//
// –ú–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–µ–π –¥–ª—è —Ç–∞–Ω–∫–æ–≤–æ–≥–æ (skid-steer) —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
//   Y ‚Äî –≥–∞–∑/—Ç–æ—Ä–º–æ–∑ (–≤–ø–µ—Ä—ë–¥/–Ω–∞–∑–∞–¥)
//   X ‚Äî –ø–æ–≤–æ—Ä–æ—Ç (–ª–µ–≤–æ/–ø—Ä–∞–≤–æ)
//
// –§–æ—Ä–º—É–ª–∞ –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏—è:
//   leftSpeed  = Y + X
//   rightSpeed = Y - X
//
// ============================================================

/**
 * @brief –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –æ—Å—è–º X/Y (–¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞)
 *
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç skid-steer (—Ç–∞–Ω–∫–æ–≤–æ–µ) –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
 *   leftSpeed  = Y + X
 *   rightSpeed = Y - X
 *
 * –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Üí –≤–ø–µ—Ä—ë–¥ (FL/FR), –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ‚Üí –Ω–∞–∑–∞–¥ (RL/RR).
 * –ú—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞: –µ—Å–ª–∏ |X| –∏ |Y| < CONTROL_DEADZONE ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞.
 *
 * @param x –û—Å—å X: -255 (–ª–µ–≤–æ) .. +255 (–ø—Ä–∞–≤–æ)
 * @param y –û—Å—å Y: -255 (–Ω–∞–∑–∞–¥) .. +255 (–≤–ø–µ—Ä—ë–¥)
 */
void controlSetXY(int16_t x, int16_t y) {
    // –û–±–Ω–æ–≤–ª—è–µ–º watchdog
    state.lastCommandMs = millis();
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    x = constrain(x, -255, 255);
    y = constrain(y, -255, 255);
    
    // –ú—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞ (deadzone) ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –º–∞–ª—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
    if (abs(x) < CONTROL_DEADZONE && abs(y) < CONTROL_DEADZONE) {
        // –î–∂–æ–π—Å—Ç–∏–∫ –≤ —Ü–µ–Ω—Ç—Ä–µ ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
        controlStop();
        return;
    }
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    state.active = true;
    
    // --- –ú–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è skid-steer ---
    // leftSpeed  = Y + X  (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π X –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤–ø—Ä–∞–≤–æ ‚Üí –ª–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –±—ã—Å—Ç—Ä–µ–µ)
    // rightSpeed = Y - X
    int16_t leftSpeed  = y + x;
    int16_t rightSpeed = y - x;
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤—ã—Ö–æ–¥—è—Ç –∑–∞ 255, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º
    // –í–∞–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞–∫ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏!
    int16_t maxVal = max(abs(leftSpeed), abs(rightSpeed));
    if (maxVal > 255) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º float –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –¥–µ–ª–µ–Ω–∏—è, –∑–∞—Ç–µ–º –æ–∫—Ä—É–≥–ª—è–µ–º
        float scale = 255.0f / maxVal;
        leftSpeed  = (int16_t)(leftSpeed * scale);
        rightSpeed = (int16_t)(rightSpeed * scale);
    }
    
    // --- –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –º–æ—Ç–æ—Ä–∞–º ---
    // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –≤–ø–µ—Ä—ë–¥ (FL, FR)
    // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –Ω–∞–∑–∞–¥ (RL, RR)
    
    // –õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (FL –¥–ª—è –≤–ø–µ—Ä—ë–¥, RL –¥–ª—è –Ω–∞–∑–∞–¥)
    if (leftSpeed >= 0) {
        driveSetSpeed(MOTOR_FL, (uint8_t)leftSpeed);
        driveSetSpeed(MOTOR_RL, 0);
    } else {
        driveSetSpeed(MOTOR_FL, 0);
        driveSetSpeed(MOTOR_RL, (uint8_t)(-leftSpeed));  // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫
    }
    
    // –ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (FR –¥–ª—è –≤–ø–µ—Ä—ë–¥, RR –¥–ª—è –Ω–∞–∑–∞–¥)
    if (rightSpeed >= 0) {
        driveSetSpeed(MOTOR_FR, (uint8_t)rightSpeed);
        driveSetSpeed(MOTOR_RR, 0);
    } else {
        driveSetSpeed(MOTOR_FR, 0);
        driveSetSpeed(MOTOR_RR, (uint8_t)(-rightSpeed));  // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–Ω–∞–∫
    }
    
    // –û—Ç–ª–∞–¥–∫–∞ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
    Serial.printf("XY: x=%d y=%d | L=%d R=%d | FL=%d FR=%d RL=%d RR=%d\n",
        x, y, leftSpeed, rightSpeed,
        driveGetSpeed(MOTOR_FL), driveGetSpeed(MOTOR_FR),
        driveGetSpeed(MOTOR_RL), driveGetSpeed(MOTOR_RR));
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if (abs(y) > abs(x)) {
        state.direction = (y > 0) ? CTRL_FORWARD : CTRL_BACKWARD;
    } else {
        state.direction = (x > 0) ? CTRL_RIGHT : CTRL_LEFT;
    }
    state.speed = (uint8_t)max(abs(leftSpeed), abs(rightSpeed));
}

// ============================================================
// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
// ============================================================

/**
 * @brief –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–æ—Ç–æ—Ä–æ–≤
 * –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (active=false), –≤—ã–∑—ã–≤–∞–µ—Ç driveStop().
 */
void controlStop() {
    state.direction = CTRL_STOP;
    state.speed = 0;
    state.active = false;
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –º–æ—Ç–æ—Ä—ã
    driveStop();
}

// ============================================================
// –ì–µ—Ç—Ç–µ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
// ============================================================

const ControlState& controlGetState() {
    return state;
}

bool controlIsActive() {
    return state.active;
}
