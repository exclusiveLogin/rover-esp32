/**
 * ============================================================
 * ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * ============================================================
 * 
 * –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏.
 * 
 * ============================================================
 */

window.AppConfig = {
  // === –°–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===
  
  // –ê–¥—Ä–µ—Å ESP32 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç)
  // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å IP: "http://192.168.1.100"
  ESP32_HOST: location.hostname,
  
  // –ê–¥—Ä–µ—Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = ESP32_HOST)
  // –ú–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: "192.168.1.101" –∏–ª–∏ "camera.local"
  VIDEO_HOST: null,  // null = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ESP32_HOST
  
  // –ü–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ HTTP —Å–µ—Ä–≤–µ—Ä–∞
  HTTP_PORT: location.port || 80,
  
  // –ü–æ—Ä—Ç —Å—Ç—Ä–∏–º–∞
  STREAM_PORT: 81,
  
  // –ü—É—Ç—å –∫ —Å—Ç—Ä–∏–º—É (–¥–ª—è IP Webcam –∏ —Ç.–¥.)
  // ESP32: "/stream", IP Webcam Android: "/video", "/videofeed" –∏ —Ç.–¥.
  STREAM_PATH: '/stream',
  
  // === MJPEG Proxy (–æ–±—Ö–æ–¥ CORS) ===
  // –î–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –±–µ–∑ CORS (IP Webcam, –≤–Ω–µ—à–Ω–∏–µ –∫–∞–º–µ—Ä—ã)
  // –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ dev-server!
  
  USE_PROXY: false,  // true = –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ dev-server
  
  // –ü–æ–ª–Ω—ã–π URL –≤–Ω–µ—à–Ω–µ–≥–æ —Å—Ç—Ä–∏–º–∞ (–¥–ª—è proxy)
  // –ü—Ä–∏–º–µ—Ä: "http://192.168.1.50:8080/video"
  EXTERNAL_STREAM_URL: null,
  
  // === API Endpoints ===
  
  // –û—Å–Ω–æ–≤–Ω–æ–π API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  CONTROL_API: '/api/control',
  
  // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π API –º–æ—Ç–æ—Ä–æ–≤
  DRIVE_API: '/api/drive',
  
  // API –∫–∞–º–µ—Ä—ã
  PHOTO_API: '/photo',
  LED_API: '/led',
  
  // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ===
  
  // ControlService –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  CONTROL: {
    tickIntervalMs: 100,      // –ò–Ω—Ç–µ—Ä–≤–∞–ª sync tick (–º—Å)
    throttleMs: 1000,         // Throttle: heartbeat —Ä–∞–∑ –≤ 1 —Å–µ–∫
    deadzone: 20,             // –ú—ë—Ä—Ç–≤–∞—è –∑–æ–Ω–∞ –¥–ª—è X/Y
    maxValue: 255,            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ X/Y
    expo: 0,                  // Expo –∫—Ä–∏–≤–∞—è: -1..+1 (0 = –ª–∏–Ω–µ–π–Ω–∞—è)
  },
  
  // === –î–∂–æ–π—Å—Ç–∏–∫–∏ ===
  
  JOYSTICK: {
    // –†–∞–∑–º–µ—Ä—ã (–±—É–¥—É—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
    defaultRadius: 120,       // –†–∞–∑–º–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (px)
    stickSize: 50,            // –†–∞–∑–º–µ—Ä —Ä—É—á–∫–∏ (px)
  },
  
  // === UI ===
  
  UI: {
    reconnectDelay: 3000,     // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∞ (–º—Å)
    errorDisplayTime: 3000,   // –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏ (–º—Å)
  },
  
  // === Computer Vision (OpenCV.js) ===
  
  CV: {
    enabled: false,           // –í–∫–ª—é—á–∏—Ç—å CV –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–º–µ–Ω—å—à–µ = –±—ã—Å—Ç—Ä–µ–µ)
    processWidth: 320,
    processHeight: 240,
    processInterval: 100,     // –º—Å –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏ (100 = 10 FPS)
    
    // –ß—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å
    showHorizon: true,        // –õ–∏–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
    showGrid: true,           // –°–µ—Ç–∫–∞ –ø–æ–ª–∞
    showWalls: true,          // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (—Å—Ç–µ–Ω—ã)
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ—Ç–µ–∫—Ü–∏–∏ –∫—Ä–∞—ë–≤ (Canny)
    cannyLow: 50,             // –ù–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥
    cannyHigh: 150,           // –í–µ—Ä—Ö–Ω–∏–π –ø–æ—Ä–æ–≥
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ—Ç–µ–∫—Ü–∏–∏ –ª–∏–Ω–∏–π (Hough)
    houghThreshold: 50,       // –ú–∏–Ω–∏–º—É–º —Ç–æ—á–µ–∫ –¥–ª—è –ª–∏–Ω–∏–∏
    houghMinLength: 50,       // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ª–∏–Ω–∏–∏
    houghMaxGap: 10,          // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑—Ä—ã–≤
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É–≥–ª—É (–≥—Ä–∞–¥—É—Å—ã)
    horizonAngleTolerance: 15,  // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    wallAngleTolerance: 15,     // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
    
    // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
    clusterTolerance: 15,       // –î–æ–ø—É—Å–∫ –ø–æ Y –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ª–∏–Ω–∏–π (px)
    minClusterSegments: 1,      // –ú–∏–Ω–∏–º—É–º —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
    horizonSmoothFrames: 5,     // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–æ N –∫–∞–¥—Ä–∞–º
    
    // –¶–≤–µ—Ç–∞
    horizonColor: '#00FF00',    // –ó–µ–ª—ë–Ω—ã–π
    gridColor: 'rgba(0, 255, 255, 0.4)',  // Cyan –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
    wallsColor: '#FF6600',      // –û—Ä–∞–Ω–∂–µ–≤—ã–π
  },
  
  // === –£—Ç–∏–ª–∏—Ç—ã ===
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π URL —Å—Ç—Ä–∏–º–∞ (—Å —É—á—ë—Ç–æ–º proxy)
   */
  getStreamUrl() {
    // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω –≤–Ω–µ—à–Ω–∏–π URL –∏ –≤–∫–ª—é—á—ë–Ω proxy
    if (this.USE_PROXY && this.EXTERNAL_STREAM_URL) {
      return `/proxy/stream?url=${encodeURIComponent(this.EXTERNAL_STREAM_URL)}`;
    }
    
    // –ü—Ä—è–º–æ–π URL
    const videoHost = this.VIDEO_HOST || this.ESP32_HOST;
    const streamPath = this.STREAM_PATH || '/stream';
    return `http://${videoHost}:${this.STREAM_PORT}${streamPath}`;
  },
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π URL API
   */
  getApiBase() {
    const port = this.HTTP_PORT === 80 ? '' : `:${this.HTTP_PORT}`;
    return `http://${this.ESP32_HOST}${port}`;
  },
  
  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π URL –¥–ª—è API endpoint
   */
  getApiUrl(endpoint) {
    return `${this.getApiBase()}${endpoint}`;
  },
  
  // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (localStorage) ===
  
  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
   * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: AppConfig.save()
   */
  save() {
    const toSave = {
      ESP32_HOST: this.ESP32_HOST,
      VIDEO_HOST: this.VIDEO_HOST,
      STREAM_PORT: this.STREAM_PORT,
      STREAM_PATH: this.STREAM_PATH,
      USE_PROXY: this.USE_PROXY,
      EXTERNAL_STREAM_URL: this.EXTERNAL_STREAM_URL,
    };
    localStorage.setItem('AppConfig', JSON.stringify(toSave));
    console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', toSave);
  },
  
  /**
   * –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   */
  load() {
    const saved = localStorage.getItem('AppConfig');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        Object.assign(this, parsed);
        console.log('üì¶ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage:', parsed);
      } catch (e) {
        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
      }
    }
  },
  
  /**
   * –°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
   */
  reset() {
    localStorage.removeItem('AppConfig');
    console.log('üóëÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
  },
};

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
window.AppConfig.load();
