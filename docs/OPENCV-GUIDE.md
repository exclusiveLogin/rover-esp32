# ๐ฏ OpenCV.js โ ะะพะผะฟัััะตัะฝะพะต ะทัะตะฝะธะต ะฒ ะฑัะฐัะทะตัะต

ะะฐะนะด ะฟะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธั OpenCV.js ะดะปั ะดะตัะตะบัะธะธ ะณะพัะธะทะพะฝัะฐ, ะฟะพะปะฐ ะธ ััะตะฝ.

---

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะงัะพ ัะฐะบะพะต OpenCV.js](#ััะพ-ัะฐะบะพะต-opencvjs)
2. [ะััะธัะตะบัััะฐ ัะตัะตะฝะธั](#ะฐััะธัะตะบัััะฐ-ัะตัะตะฝะธั)
3. [ะัะฝะพะฒะฝัะต ะบะพะฝัะตะฟัะธะธ OpenCV](#ะพัะฝะพะฒะฝัะต-ะบะพะฝัะตะฟัะธะธ-opencv)
4. [ะะตัะตะบัะธั ะณะพัะธะทะพะฝัะฐ](#ะดะตัะตะบัะธั-ะณะพัะธะทะพะฝัะฐ)
5. [ะะตัะตะบัะธั ะฟะพะปะฐ (ัะตัะบะฐ)](#ะดะตัะตะบัะธั-ะฟะพะปะฐ-ัะตัะบะฐ)
6. [ะะตัะตะบัะธั ััะตะฝ](#ะดะตัะตะบัะธั-ััะตะฝ)
7. [ะะฟัะธะผะธะทะฐัะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ](#ะพะฟัะธะผะธะทะฐัะธั-ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ)

---

## ะงัะพ ัะฐะบะพะต OpenCV.js

**OpenCV.js** โ ััะพ JavaScript-ะฟะพัั ะฑะธะฑะปะธะพัะตะบะธ OpenCV, ัะบะพะผะฟะธะปะธัะพะฒะฐะฝะฝัะน ะฒ WebAssembly.

### ะะปััั
- โ ะะฐะฑะพัะฐะตั ะฟะพะปะฝะพัััั ะฒ ะฑัะฐัะทะตัะต (ะฑะตะท ัะตัะฒะตัะฐ)
- โ ะััะพะบะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั (WASM)
- โ ะะพะณะฐััะน ััะฝะบัะธะพะฝะฐะป (ัะธะปัััั, ะดะตัะตะบัะธั, ััะฐะฝััะพัะผะฐัะธะธ)

### ะะธะฝััั
- โ ะะพะปััะพะน ัะฐะทะผะตั (~8 MB)
- โ ะัะตะผั ะทะฐะณััะทะบะธ (~2-5 ัะตะบ)
- โ ะะณัะฐะฝะธัะตะฝ ัะตััััะฐะผะธ ะฑัะฐัะทะตัะฐ

### ะฃััะฐะฝะพะฒะบะฐ (ะปะพะบะฐะปัะฝะฐั ะบะพะฟะธั)

OpenCV.js (~11MB) ะฝะต ะฒะบะปัััะฝ ะฒ ัะตะฟะพะทะธัะพัะธะน. ะกะบะฐัะฐะน ะฟะตัะตะด ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ:

```bash
# Windows (PowerShell)
Invoke-WebRequest -Uri "https://docs.opencv.org/4.x/opencv.js" -OutFile "data/opencv.js"

# Linux/macOS
curl -L "https://docs.opencv.org/4.x/opencv.js" -o data/opencv.js
```

### ะะพะดะบะปััะตะฝะธะต

```html
<!-- ะะพะบะฐะปัะฝะฐั ะบะพะฟะธั (ัะตะบะพะผะตะฝะดัะตััั) -->
<script async src="/opencv.js" onload="onOpenCvReady()"></script>

<!-- ะะปะธ CDN (ััะตะฑัะตั ะธะฝัะตัะฝะตั) -->
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
```

```javascript
function onOpenCvReady() {
  console.log('OpenCV.js ะณะพัะพะฒ!', cv.getBuildInformation());
}
```

---

## ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ะะะะฃะะะ                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                 โ
โ   ะััะพัะฝะธะบ A: ESP32/IP ะบะฐะผะตัะฐ        ะััะพัะฝะธะบ B: ะะตะฑะบะฐ          โ
โ   โโโโโโโโโโโโโโโ                    โโโโโโโโโโโโโโโ            โ
โ   โ   <img>     โ                    โ  <video>    โ            โ
โ   โ  MJPEG      โ                    โ getUserMediaโ            โ
โ   โ  (+ CORS)   โ                    โ (ะฑะตะท CORS!) โ            โ
โ   โโโโโโโโฌโโโโโโโ                    โโโโโโโโฌโโโโโโโ            โ
โ          โ                                  โ                   โ
โ          โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ                   โ
โ                         โผ                                       โ
โ                  โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ             โ
โ                  โ  Canvas     โโโโโบโ  Canvas     โ             โ
โ                  โ  (hidden)   โ    โ  (overlay)  โ             โ
โ                  โโโโโโโโฌโโโโโโโ    โโโโโโโโโโโโโโโ             โ
โ                         โ                                       โ
โ                         โผ                                       โ
โ                  โโโโโโโโโโโโโโโ                                โ
โ                  โ  OpenCV.js  โ                                โ
โ                  โ  ะพะฑัะฐะฑะพัะบะฐ  โ                                โ
โ                  โโโโโโโโฌโโโโโโโ                                โ
โ                         โ                                       โ
โ                         โผ                                       โ
โ                  โโโโโโโโโโโโโโโ                                โ
โ                  โ  ะะตะทัะปััะฐั: โ                                โ
โ                  โ  - ะณะพัะธะทะพะฝั โ                                โ
โ                  โ  - ัะตัะบะฐ    โ                                โ
โ                  โ  - ััะตะฝั    โ                                โ
โ                  โโโโโโโโโโโโโโโ                                โ
โ                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะััะพัะฝะธะบะธ ะฒะธะดะตะพ

| ะััะพัะฝะธะบ | ะญะปะตะผะตะฝั | CORS | ะะฟะธัะฐะฝะธะต |
|----------|---------|------|----------|
| ESP32 MJPEG | `<img>` | ะัะถะตะฝ | ะกััะธะผ ั ัะพะฒะตัะฐ (CORS ะฝะฐัััะพะตะฝ) |
| IP ะบะฐะผะตัะฐ | `<img>` | ะัะถะตะฝ | ะะพะถะตั ะฝะต ะฟะพะดะดะตัะถะธะฒะฐัั CORS |
| **ะะตะฑะบะฐ** | `<video>` | **ะะต ะฝัะถะตะฝ** | getUserMedia โ ะปะพะบะฐะปัะฝัะน ะดะพัััะฟ |
| **ะขะตะปะตัะพะฝ** | `<video>` | **ะะต ะฝัะถะตะฝ** | getUserMedia โ ะปะพะบะฐะปัะฝัะน ะดะพัััะฟ |

**๐ก ะกะพะฒะตั:** ะะปั ะพัะปะฐะดะบะธ CV ะฑะตะท ัะพะฒะตัะฐ ะธัะฟะพะปัะทัะน ะบะฝะพะฟะบั "ะะตะฑะบะฐ"!

### ะะพัะพะบ ะดะฐะฝะฝัั

1. **ะะธะดะตะพ** โ `<img>` ัะปะตะผะตะฝั (MJPEG ัััะธะผ)
2. **ะะฐัะฒะฐั ะบะฐะดัะฐ** โ ัะบััััะน `<canvas>` (ะดะปั OpenCV)
3. **ะะฑัะฐะฑะพัะบะฐ** โ OpenCV.js ะฐะฝะฐะปะธะทะธััะตั ะบะฐะดั
4. **ะะตะฝะดะตั** โ ัะตะทัะปััะฐั ัะธััะตััั ะฝะฐ overlay canvas

### ะะฟัะธะพะฝะฐะปัะฝะพััั

CV ะพะฑัะฐะฑะพัะบะฐ **ะฟะพะปะฝะพัััั ะพะฟัะธะพะฝะฐะปัะฝะฐ**:
- ะะตะท OpenCV.js โ ะฟัะพััะพ ะฒะธะดะตะพะฟะพัะพะบ
- ะก OpenCV.js โ ะฒะธะดะตะพ + overlay ั ะดะตัะตะบัะธะตะน

---

## ะัะฝะพะฒะฝัะต ะบะพะฝัะตะฟัะธะธ OpenCV

### Mat (ะะฐััะธัะฐ)

**Mat** โ ะพัะฝะพะฒะฝะฐั ััััะบัััะฐ ะดะฐะฝะฝัั. ะญัะพ ะผะฝะพะณะพะผะตัะฝัะน ะผะฐััะธะฒ ะดะปั ััะฐะฝะตะฝะธั ะธะทะพะฑัะฐะถะตะฝะธะน.

```javascript
// ะกะพะทะดะฐะฝะธะต Mat ะธะท canvas
let src = cv.imread(canvasElement);

// ะกะพะทะดะฐะฝะธะต ะฟัััะพะณะพ Mat
let dst = new cv.Mat();

// ะะะะะ: ะฒัะตะณะดะฐ ะพัะฒะพะฑะพะถะดะฐะน ะฟะฐะผััั!
src.delete();
dst.delete();
```

### ะฆะฒะตัะพะฒัะต ะฟัะพัััะฐะฝััะฒะฐ

```javascript
// BGR โ Grayscale (ะพััะตะฝะบะธ ัะตัะพะณะพ)
cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

// BGR โ HSV (ะดะปั ะดะตัะตะบัะธะธ ัะฒะตัะพะฒ)
cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);
```

### ะะฐะทะผััะธะต (Blur)

ะฃะฑะธัะฐะตั ััะผ ะฟะตัะตะด ะดะตัะตะบัะธะตะน:

```javascript
// ะะฐัััะพะฒะพ ัะฐะทะผััะธะต
cv.GaussianBlur(src, dst, new cv.Size(5, 5), 0);

// ะะตะดะธะฐะฝะฝะพะต ัะฐะทะผััะธะต (ะปัััะต ะดะปั ััะผะฐ)
cv.medianBlur(src, dst, 5);
```

### ะะตัะตะบัะธั ะบัะฐัะฒ (Canny)

ะะฐัะพะดะธั ะณัะฐะฝะธัั ะพะฑัะตะบัะพะฒ:

```javascript
cv.Canny(gray, edges, 50, 150);
//                    โ    โ
//                    โ    โโโ ะฒะตััะฝะธะน ะฟะพัะพะณ
//                    โโโโโโโโ ะฝะธะถะฝะธะน ะฟะพัะพะณ
```

### ะะตัะตะบัะธั ะปะธะฝะธะน (Hough Transform)

```javascript
// ะะตัะพััะฝะพััะฝะพะต ะฟัะตะพะฑัะฐะทะพะฒะฐะฝะธะต ะฅะฐัะฐ
let lines = new cv.Mat();
cv.HoughLinesP(
  edges,      // ะฒัะพะดะฝะพะต ะธะทะพะฑัะฐะถะตะฝะธะต (ะบัะฐั)
  lines,      // ะฒััะพะดะฝัะต ะปะธะฝะธะธ
  1,          // ัะฐะทัะตัะตะฝะธะต ฯ (ะฟะธะบัะตะปะธ)
  Math.PI/180,// ัะฐะทัะตัะตะฝะธะต ฮธ (ัะฐะดะธะฐะฝั)
  50,         // ะฟะพัะพะณ (ะผะธะฝะธะผัะผ ัะพัะตะบ ะฝะฐ ะปะธะฝะธะธ)
  50,         // ะผะธะฝะธะผะฐะปัะฝะฐั ะดะปะธะฝะฐ ะปะธะฝะธะธ
  10          // ะผะฐะบัะธะผะฐะปัะฝัะน ัะฐะทััะฒ ะผะตะถะดั ัะพัะบะฐะผะธ
);
```

---

## ะะตัะตะบัะธั ะณะพัะธะทะพะฝัะฐ

### ะขะตะพัะธั

ะะพัะธะทะพะฝั โ ััะพ **ะณะพัะธะทะพะฝัะฐะปัะฝะฐั ะปะธะฝะธั**, ัะฐะทะดะตะปัััะฐั ะฝะตะฑะพ/ะฟะพัะพะปะพะบ ะธ ะทะตะผะปั/ะฟะพะป.

### โ๏ธ ะัะพะฑะปะตะผะฐ ะฟัะพััะพะณะพ ะฟะพะดัะพะดะฐ

**"ะะทััั ัะฐะผัั ะดะปะธะฝะฝัั ะปะธะฝะธั"** โ ะฝะตะฝะฐะดัะถะฝะพ:

```
ะัะพะฑะปะตะผะฐ 1: ะะพัะธะทะพะฝั ะฟัะตัะฒะฐะฝ ะพะฑัะตะบัะฐะผะธ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     ๐ณ      ๐     ๐ณ          ๐
  โโโโฌโโโ  โโโฌโโ  โโโโฌโโโ    โโโฌโโ     โ ะผะฝะพะณะพ ะบะพัะพัะบะธั ัะตะณะผะตะฝัะพะฒ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะัะพะฑะปะตะผะฐ 2: ะกะฐะผะฐั ะดะปะธะฝะฝะฐั ะปะธะฝะธั โ ะณะพัะธะทะพะฝั
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โโ โโโ โโโโ                             โ ะฝะฐััะพััะธะน ะณะพัะธะทะพะฝั (ัะฐะทะพัะฒะฐะฝ)
  
  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ ะบัะฐะน ััะพะปะฐ (ะดะปะธะฝะฝะตะต!)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### โ Robust ะฐะปะณะพัะธัะผ: ะะปะฐััะตัะธะทะฐัะธั ะฟะพ Y

**ะะดะตั:** ะะพัะธะทะพะฝั โ ััะพ **ะฒััะพัะฐ, ะฝะฐ ะบะพัะพัะพะน ัะบะพะฝัะตะฝััะธัะพะฒะฐะฝะพ ะผะฝะพะณะพ ะณะพัะธะทะพะฝัะฐะปัะฝัั ะปะธะฝะธะน**.

**ะะปะณะพัะธัะผ:**
1. ะะฐัะพะดะธะผ ะฒัะต ะณะพัะธะทะพะฝัะฐะปัะฝัะต ะปะธะฝะธะธ
2. ะััะฟะฟะธััะตะผ ะฟะพ Y-ะบะพะพัะดะธะฝะฐัะต (ยฑtolerance)
3. ะะปั ะบะฐะถะดะพะณะพ ะบะปะฐััะตัะฐ ััะธัะฐะตะผ **score = ััะผะผะฐ ะดะปะธะฝ ร ะบะพะปะธัะตััะฒะพ ัะตะณะผะตะฝัะพะฒ**
4. ะคะธะปััััะตะผ ะฟะพ ะทะพะฝะต (ะณะพัะธะทะพะฝั ะพะฑััะฝะพ ะฒ ะฒะตััะฝะตะน ะฟะพะปะพะฒะธะฝะต)
5. ะัะฑะธัะฐะตะผ ะบะปะฐััะตั ั ะผะฐะบัะธะผะฐะปัะฝัะผ score

```
Y=100: โโโ โโโ โโโโ      score = 200 ร 3 = 600
Y=150: โโ โโโ โโ โโโโโ   score = 280 ร 4 = 1120  โ ะะะะะะะขะะะฌ
Y=300: โโโโโโโโโโโโโโโโ  score = 400 ร 1 = 400   (1 ะปะธะฝะธั = ัะปะฐะฑัะน ะบะปะฐััะตั)
```

### ะะพะด

```javascript
/**
 * Robust ะดะตัะตะบัะธั ะณะพัะธะทะพะฝัะฐ ัะตัะตะท ะบะปะฐััะตัะธะทะฐัะธั
 */
function detectHorizon(src, config = {}) {
  const width = src.cols;
  const height = src.rows;
  
  // ะะฐัััะพะนะบะธ
  const {
    clusterTolerance = 15,      // ะะพะฟััะบ ะฟะพ Y ะดะปั ะบะปะฐััะตัะธะทะฐัะธะธ (px)
    angleTolerance = 15,        // ะะพะฟััะบ ัะณะปะฐ ะพั ะณะพัะธะทะพะฝัะฐะปะธ (ะณัะฐะดััั)
    searchZoneTop = 0.1,        // ะะตััะฝัั ะณัะฐะฝะธัะฐ ะฟะพะธัะบะฐ (% ะฒััะพัั)
    searchZoneBottom = 0.7,     // ะะธะถะฝัั ะณัะฐะฝะธัะฐ ะฟะพะธัะบะฐ (% ะฒััะพัั)
    minClusterSegments = 2,     // ะะธะฝะธะผัะผ ัะตะณะผะตะฝัะพะฒ ะฒ ะบะปะฐััะตัะต
  } = config;
  
  // 1. ะะพะดะณะพัะพะฒะบะฐ
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
  
  let edges = new cv.Mat();
  cv.Canny(gray, edges, 50, 150);
  
  let lines = new cv.Mat();
  cv.HoughLinesP(edges, lines, 1, Math.PI/180, 50, 30, 15);
  
  // 2. ะกะพะฑะธัะฐะตะผ ะณะพัะธะทะพะฝัะฐะปัะฝัะต ะปะธะฝะธะธ
  const horizontalLines = [];
  for (let i = 0; i < lines.rows; i++) {
    const x1 = lines.data32S[i * 4];
    const y1 = lines.data32S[i * 4 + 1];
    const x2 = lines.data32S[i * 4 + 2];
    const y2 = lines.data32S[i * 4 + 3];
    
    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
    const avgY = (y1 + y2) / 2;
    
    // ะคะธะปััั: ะณะพัะธะทะพะฝัะฐะปัะฝัะต + ะฒ ะทะพะฝะต ะฟะพะธัะบะฐ
    const isHorizontal = Math.abs(angle) < angleTolerance || Math.abs(angle) > (180 - angleTolerance);
    const inSearchZone = avgY > height * searchZoneTop && avgY < height * searchZoneBottom;
    
    if (isHorizontal && inSearchZone) {
      const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
      horizontalLines.push({ x1, y1, x2, y2, avgY, length });
    }
  }
  
  // 3. ะะปะฐััะตัะธะทะฐัะธั ะฟะพ Y
  const clusters = [];
  const used = new Set();
  
  for (let i = 0; i < horizontalLines.length; i++) {
    if (used.has(i)) continue;
    
    const cluster = [horizontalLines[i]];
    used.add(i);
    
    // ะะพะฑะฐะฒะปัะตะผ ัะพัะตะดะฝะธะต ะปะธะฝะธะธ ะฒ ะบะปะฐััะตั
    for (let j = i + 1; j < horizontalLines.length; j++) {
      if (used.has(j)) continue;
      
      // ะัะพะฒะตััะตะผ ะฑะปะธะทะพััั ะฟะพ Y ะบ ะปัะฑะพะน ะปะธะฝะธะธ ะฒ ะบะปะฐััะตัะต
      const line = horizontalLines[j];
      const isNear = cluster.some(c => Math.abs(c.avgY - line.avgY) < clusterTolerance);
      
      if (isNear) {
        cluster.push(line);
        used.add(j);
      }
    }
    
    clusters.push(cluster);
  }
  
  // 4. ะัะตะฝะธะฒะฐะตะผ ะบะปะฐััะตัั
  const scoredClusters = clusters
    .filter(c => c.length >= minClusterSegments)
    .map(cluster => {
      const totalLength = cluster.reduce((sum, l) => sum + l.length, 0);
      const segmentCount = cluster.length;
      const avgY = cluster.reduce((sum, l) => sum + l.avgY, 0) / segmentCount;
      
      // Score: ะดะปะธะฝะฐ ร ะบะพะปะธัะตััะฒะพ ัะตะณะผะตะฝัะพะฒ
      // ะะพะฝัั ะทะฐ ะฑะพะปััะต ัะตะณะผะตะฝัะพะฒ (ะฟัะธะทะฝะฐะบ ัะตะฐะปัะฝะพะณะพ ะณะพัะธะทะพะฝัะฐ)
      const score = totalLength * Math.sqrt(segmentCount);
      
      return { cluster, totalLength, segmentCount, avgY, score };
    })
    .sort((a, b) => b.score - a.score);
  
  // Cleanup
  gray.delete();
  edges.delete();
  lines.delete();
  
  // 5. ะะพะทะฒัะฐัะฐะตะผ ะปัััะธะน ะบะปะฐััะตั
  if (scoredClusters.length === 0) return null;
  
  const best = scoredClusters[0];
  
  return {
    y: best.avgY,                    // Y-ะบะพะพัะดะธะฝะฐัะฐ ะณะพัะธะทะพะฝัะฐ
    segments: best.cluster,          // ะัะต ัะตะณะผะตะฝัั
    confidence: Math.min(best.score / 1000, 1),  // 0..1
    segmentCount: best.segmentCount,
    totalLength: best.totalLength,
  };
}
```

### ะะธะทัะฐะปะธะทะฐัะธั

```javascript
function drawHorizon(ctx, horizon, canvasWidth) {
  if (!horizon) return;
  
  const { y, confidence, segments } = horizon;
  
  // ะัะฝะพะฒะฝะฐั ะปะธะฝะธั ะณะพัะธะทะพะฝัะฐ
  ctx.strokeStyle = `rgba(0, 255, 0, ${0.5 + confidence * 0.5})`;
  ctx.lineWidth = 2;
  ctx.setLineDash([10, 5]);
  
  ctx.beginPath();
  ctx.moveTo(0, y);
  ctx.lineTo(canvasWidth, y);
  ctx.stroke();
  
  ctx.setLineDash([]);
  
  // ะัะดะตะปัะฝัะต ัะตะณะผะตะฝัั (ะดะปั ะพัะปะฐะดะบะธ)
  ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
  ctx.lineWidth = 4;
  segments.forEach(seg => {
    ctx.beginPath();
    ctx.moveTo(seg.x1, seg.y1);
    ctx.lineTo(seg.x2, seg.y2);
    ctx.stroke();
  });
  
  // ะะตัะบะฐ ั confidence
  ctx.fillStyle = '#00FF00';
  ctx.font = '12px monospace';
  ctx.fillText(`HORIZON (${Math.round(confidence * 100)}%)`, 10, y - 5);
}
```

### ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะปัััะตะฝะธั

**ะัะตะผะตะฝะฝะฐั ัะธะปัััะฐัะธั (ัะณะปะฐะถะธะฒะฐะฝะธะต ะฟะพ ะบะฐะดัะฐะผ):**

```javascript
class HorizonSmoother {
  constructor(bufferSize = 5) {
    this.buffer = [];
    this.bufferSize = bufferSize;
  }
  
  update(horizonY) {
    if (horizonY === null) return this.get();
    
    this.buffer.push(horizonY);
    if (this.buffer.length > this.bufferSize) {
      this.buffer.shift();
    }
    
    return this.get();
  }
  
  get() {
    if (this.buffer.length === 0) return null;
    
    // ะะตะดะธะฐะฝะฐ (ัััะพะนัะธะฒะฐ ะบ ะฒัะฑัะพัะฐะผ)
    const sorted = [...this.buffer].sort((a, b) => a - b);
    return sorted[Math.floor(sorted.length / 2)];
  }
}
```

---

## ะะตัะตะบัะธั ะฟะพะปะฐ (ัะตัะบะฐ)

### ะขะตะพัะธั

ะะปั ะพััะธัะพะฒะบะธ ัะตัะบะธ ะฝะฐ ะฟะพะปั ะฝัะถะฝะฐ **ัะพัะบะฐ ััะพะดะฐ (vanishing point)** โ ัะพัะบะฐ, ะณะดะต ะฟะฐัะฐะปะปะตะปัะฝัะต ะปะธะฝะธะธ ะฟะพะปะฐ "ััะพะดัััั" ะธะท-ะทะฐ ะฟะตััะฟะตะบัะธะฒั.

**ะะปะณะพัะธัะผ:**
1. ะะฐัะพะดะธะผ ะฒัะต ะปะธะฝะธะธ
2. ะัะพะดะปะตะฒะฐะตะผ ะธั ะดะพ ะฟะตัะตัะตัะตะฝะธั
3. ะะปะฐััะตัะธะทัะตะผ ัะพัะบะธ ะฟะตัะตัะตัะตะฝะธั
4. ะะฐัะพะดะธะผ ะดะพะผะธะฝะฐะฝัะฝัั ัะพัะบั ััะพะดะฐ
5. ะะธััะตะผ ัะตัะบั ะพั ััะพะน ัะพัะบะธ

### ะฃะฟัะพััะฝะฝัะน ะฟะพะดัะพะด

ะะปั ะฝะฐัะฐะปะฐ ะธัะฟะพะปัะทัะตะผ **ัะธะบัะธัะพะฒะฐะฝะฝัั ัะพัะบั ััะพะดะฐ** ะฒ ัะตะฝััะต ะณะพัะธะทะพะฝัะฐ:

```javascript
function drawPerspectiveGrid(ctx, horizon, width, height) {
  if (!horizon) return;
  
  // ะขะพัะบะฐ ััะพะดะฐ โ ัะตะฝัั ะณะพัะธะทะพะฝัะฐ
  const vpX = (horizon.x1 + horizon.x2) / 2;
  const vpY = (horizon.y1 + horizon.y2) / 2;
  
  ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';  // cyan
  ctx.lineWidth = 1;
  
  // ะะตััะธะบะฐะปัะฝัะต ะปะธะฝะธะธ ัะตัะบะธ (ะพั ัะพัะบะธ ััะพะดะฐ ะบ ะฝะธะทั)
  const gridLines = 10;
  const bottomY = height;
  
  for (let i = 0; i <= gridLines; i++) {
    const t = i / gridLines;
    const bottomX = t * width;
    
    ctx.beginPath();
    ctx.moveTo(vpX, vpY);
    ctx.lineTo(bottomX, bottomY);
    ctx.stroke();
  }
  
  // ะะพัะธะทะพะฝัะฐะปัะฝัะต ะปะธะฝะธะธ ัะตัะบะธ (ั ะฟะตััะฟะตะบัะธะฒะพะน)
  const horizonY = vpY;
  const gridRows = 8;
  
  for (let i = 1; i <= gridRows; i++) {
    // ะะตะปะธะฝะตะนะฝะพะต ัะฐัะฟัะตะดะตะปะตะฝะธะต (ะฑะปะธะถะต ะบ ะณะพัะธะทะพะฝัั โ ะฟะปะพัะฝะตะต)
    const t = Math.pow(i / gridRows, 1.5);
    const y = horizonY + t * (bottomY - horizonY);
    
    // ะจะธัะธะฝะฐ ะปะธะฝะธะธ ะทะฐะฒะธัะธั ะพั ัะฐัััะพัะฝะธั ะดะพ ะณะพัะธะทะพะฝัะฐ
    const perspectiveScale = (y - horizonY) / (bottomY - horizonY);
    const halfWidth = (width / 2) * perspectiveScale;
    
    ctx.beginPath();
    ctx.moveTo(vpX - halfWidth, y);
    ctx.lineTo(vpX + halfWidth, y);
    ctx.stroke();
  }
}
```

---

## ะะตัะตะบัะธั ััะตะฝ

### ะขะตะพัะธั

ะกัะตะฝั โ ััะพ **ะฒะตััะธะบะฐะปัะฝัะต ะฟะพะฒะตััะฝะพััะธ**. ะะตัะตะบัะธััะตะผ:
1. ะะตััะธะบะฐะปัะฝัะต ะปะธะฝะธะธ (ัะณะปั ััะตะฝ)
2. ะะตััะธะบะฐะปัะฝัะต ะบะพะฝัััั

### ะะพะด

```javascript
function detectWalls(src) {
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
  
  let edges = new cv.Mat();
  cv.Canny(gray, edges, 50, 150);
  
  let lines = new cv.Mat();
  cv.HoughLinesP(edges, lines, 1, Math.PI/180, 50, 80, 10);
  
  // ะคะธะปััััะตะผ ะฒะตััะธะบะฐะปัะฝัะต ะปะธะฝะธะธ
  let verticalLines = [];
  for (let i = 0; i < lines.rows; i++) {
    let x1 = lines.data32S[i * 4];
    let y1 = lines.data32S[i * 4 + 1];
    let x2 = lines.data32S[i * 4 + 2];
    let y2 = lines.data32S[i * 4 + 3];
    
    let angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
    
    // ะะตััะธะบะฐะปัะฝัะต: ัะณะพะป ะฑะปะธะทะพะบ ะบ 90ยฐ ะธะปะธ -90ยฐ
    if (Math.abs(Math.abs(angle) - 90) < 15) {
      let length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
      verticalLines.push({ x1, y1, x2, y2, length });
    }
  }
  
  gray.delete();
  edges.delete();
  lines.delete();
  
  return verticalLines;
}

function drawWalls(ctx, walls) {
  ctx.strokeStyle = '#FF6600';  // ะพัะฐะฝะถะตะฒัะน
  ctx.lineWidth = 2;
  
  walls.forEach(wall => {
    ctx.beginPath();
    ctx.moveTo(wall.x1, wall.y1);
    ctx.lineTo(wall.x2, wall.y2);
    ctx.stroke();
  });
}
```

---

## ะะฟัะธะผะธะทะฐัะธั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

### 1. ะฃะผะตะฝััะตะฝะธะต ัะฐะทัะตัะตะฝะธั

ะะฑัะฐะฑะฐััะฒะฐะน ัะผะตะฝััะตะฝะฝัั ะบะพะฟะธั:

```javascript
const PROCESS_WIDTH = 320;  // ะพะฑัะฐะฑะฐััะฒะฐะตะผ ะฒ 320px
const PROCESS_HEIGHT = 240;

let small = new cv.Mat();
cv.resize(src, small, new cv.Size(PROCESS_WIDTH, PROCESS_HEIGHT));

// ... ะพะฑัะฐะฑะพัะบะฐ small ...

// ะะฐัััะฐะฑะธััะตะผ ัะตะทัะปััะฐัั ะพะฑัะฐัะฝะพ
const scaleX = originalWidth / PROCESS_WIDTH;
const scaleY = originalHeight / PROCESS_HEIGHT;
```

### 2. Throttling

ะะต ะพะฑัะฐะฑะฐััะฒะฐะน ะบะฐะถะดัะน ะบะฐะดั:

```javascript
let lastProcessTime = 0;
const PROCESS_INTERVAL = 100;  // 10 FPS ะดะปั CV

function processFrame() {
  const now = Date.now();
  if (now - lastProcessTime < PROCESS_INTERVAL) return;
  lastProcessTime = now;
  
  // ... ะพะฑัะฐะฑะพัะบะฐ ...
}
```

### 3. Web Worker

ะัะฝะตัะธ ััะถัะปัั ะพะฑัะฐะฑะพัะบั ะฒ Worker:

```javascript
// main.js
const cvWorker = new Worker('cv-worker.js');

cvWorker.postMessage({ 
  imageData: ctx.getImageData(0, 0, width, height) 
});

cvWorker.onmessage = (e) => {
  const { horizon, grid, walls } = e.data;
  drawOverlay(horizon, grid, walls);
};
```

```javascript
// cv-worker.js
importScripts('opencv.js');

onmessage = function(e) {
  const { imageData } = e.data;
  
  // ... OpenCV ะพะฑัะฐะฑะพัะบะฐ ...
  
  postMessage({ horizon, grid, walls });
};
```

### 4. ะัะธััะบะฐ ะฟะฐะผััะธ

**ะะะะขะะงะะ!** OpenCV.js ะฝะต ะธะผะตะตั garbage collection ะดะปั Mat:

```javascript
function process(src) {
  let gray = new cv.Mat();
  let edges = new cv.Mat();
  
  try {
    // ... ะพะฑัะฐะฑะพัะบะฐ ...
    return result;
  } finally {
    // ะะกะะะะ ะพัะธัะฐะน!
    gray.delete();
    edges.delete();
  }
}
```

---

## ะกะปะตะดัััะธะต ัะฐะณะธ

1. **[cv-processor.js](../data/cv-processor.js)** โ ะผะพะดัะปั ะพะฑัะฐะฑะพัะบะธ
2. **ะะฝัะตะณัะฐัะธั ะฒ UI** โ ะบะฝะพะฟะบะฐ ะฒะบะป/ะฒัะบะป CV
3. **ะะฐัััะพะนะบะธ** โ ะฟะพัะพะณะธ ะดะตัะตะบัะธะธ ะฒ config.js
4. **ะะฐะปะธะฑัะพะฒะบะฐ ะบะฐะผะตัั** โ ะดะปั fisheye ะปะธะฝะท

---

## ะะพะปะตะทะฝัะต ัััะปะบะธ

- [OpenCV.js Tutorials](https://docs.opencv.org/4.x/d5/d10/tutorial_js_root.html)
- [OpenCV.js API Reference](https://docs.opencv.org/4.x/d5/d10/tutorial_js_root.html)
- [Hough Line Transform](https://docs.opencv.org/4.x/d9/db0/tutorial_hough_lines.html)
- [Canny Edge Detection](https://docs.opencv.org/4.x/da/d22/tutorial_py_canny.html)
